[uwsgi]
# User and group to run the application
uid = searxng
gid = searxng

# Number of worker processes (match the number of CPU cores or %k for auto-detection)
# More workers handle more requests in parallel but consume more memory.
workers = %k

# Number of threads per worker (balance based on workload)
# Default is 4; consider increasing if you expect high concurrency.
threads = 8

# Permissions for the socket file
chmod-socket = 666

# Enable master process management and single interpreter mode for performance
master = true
single-interpreter = true

# Load the Python 3 plugin
plugin = python3

# Ensure threads are enabled
lazy-apps = true
enable-threads = true

# Define the Python module to run
module = searx.webapp

# Set the working directory and Python path
pythonpath = /usr/local/searxng/
chdir = /usr/local/searxng/searx/

# Automatically set process names for easier debugging
auto-procname = true

# Optimize logging for better performance and debugging
disable-logging = false  # Enable logging for development
log-5xx = true           # Log 5xx errors for debugging
log-reopen = true        # Handle log rotation properly
log-format = %(method) %(uri) => %(status) [%(msecs) ms]

# Set the maximum size of HTTP headers (in bytes)
# Default is 8192; increase if handling large requests or headers.
buffer-size = 16384  # Doubled to handle larger request headers

# Disable keep-alive connections for better resource utilization
add-header = Connection: close

# Serve static files efficiently
static-map = /static=/usr/local/searxng/searx/static
static-expires = /* 86400
static-gzip-all = true

# Offload static file handling to threads
offload-threads = 4

# Advanced options for performance tuning
harakiri = 30               # Kill requests taking more than 30 seconds
max-requests = 5000         # Restart workers after serving this many requests to prevent memory leaks
post-buffering = 8192       # Cache the first 8KB of POST requests for faster handling

# Configure error and health monitoring
ignore-sigpipe = true
ignore-write-errors = true
disable-write-exception = true
